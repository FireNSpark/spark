<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spark of Fire</title>
  <style>
    body {
      background-color: #111; color: #eee; font-family: Arial, sans-serif;
      margin: 0; padding: 0; display: flex; flex-direction: row; height: 100vh;
    }
    #sidebar { width: 50px; background-color: #1a1a1a; padding: 5px;
      display: flex; flex-direction: column; gap: 6px; overflow-y: auto; align-items: center; position: relative; }
    #main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; }

    #chatBox {
      width: 85%; max-width: 420px; height: 240px; overflow-y: auto;
      background: #222; border: 1px solid #444; padding: 6px; margin-top: 20px; font-size: 14px;
    }
    .user-message { text-align: right; margin: 5px; color: #99f; white-space: pre-wrap; }
    .bot-message  { text-align: left;  margin: 5px; color: #9f9; white-space: pre-wrap; }
    #controls { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
    #userInput { flex: 1; padding: 8px; }
    button { padding: 8px 12px; cursor: pointer; }

    #avatarImage {
      margin-top: 20px; width: 600px; height: 600px; background-color: #333; border-radius: 50%;
      box-shadow: 0 0 15px #0ff; transition: box-shadow 0.2s ease, transform 0.2s ease; object-fit: cover; flex-shrink: 0;
    }
    @keyframes pulse { 0%{box-shadow:0 0 20px #0f0; transform:scale(1);}
      50%{box-shadow:0 0 40px #0ff; transform:scale(1.05);}
      100%{box-shadow:0 0 20px #0f0; transform:scale(1);} }

    .status { font-size: 12px; opacity: .85; margin-top: 8px; min-height: 1em; }

    #codes {
      width: 85%; max-width: 420px; margin-top: 16px; background:#1b1b1b;
      border:1px solid #333; padding:10px; font-size:14px;
    }
    #codes ul { margin: 0; padding-left: 18px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <button onclick="togglePanel()">‚öôÔ∏è</button>
    <div id="functionPanel" class="hidden"></div>
  </div>

  <div id="main">
    <img id="avatarImage" src="/cartoonpersona.png" alt="Avatar">
    <div style="display:flex; flex-direction:column; flex-grow:1; justify-content:flex-start; align-items:center; width:100%; max-width:720px;">
      <div id="chatBox"></div>
      <div id="controls">
        <input type="text" id="userInput" placeholder="Say something‚Ä¶">
        <button id="micBtn" title="Tap to talk">üéôÔ∏è</button>
        <button id="sendBtn">Send</button>
      </div>
      <div id="status" class="status"></div>
      <div id="codes">Loading codes‚Ä¶</div>
    </div>
  </div>

  <script>
    function togglePanel(){ const p=document.getElementById('functionPanel'); if(!p) return; p.classList.toggle('hidden'); }

    const memory = { mood:"neutral", fragments:[], history:[], identity:"Spark", casualTone:true };
    let remoteMemory = {};

    const sendBtn = document.getElementById("sendBtn");
    const micBtn  = document.getElementById("micBtn");
    const inputEl = document.getElementById("userInput");
    const chatBox = document.getElementById("chatBox");
    const statusEl= document.getElementById("status");
    const avatar  = document.getElementById("avatarImage");

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function addMessage(sender, text){
      const div = document.createElement("div");
      div.className = sender === "user" ? "user-message" : "bot-message";
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function speakText(text){
      try {
        if (!window.speechSynthesis) return;
        const u = new SpeechSynthesisUtterance(text);
        u.onstart = ()=>{ if (avatar) avatar.style.animation = "pulse 1s ease-in-out infinite"; };
        u.onend   = ()=>{ if (avatar) avatar.style.animation = ""; };
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch {}
    }

    // Minimal API Chat wired to /api/chat
    async function apiChat(userText){
      const payload = {
        system: "You are Spark. Keep it direct. No fluff.",
        messages: [{ role: "user", content: userText }]
      };
      try {
        const r = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j?.error || "brain_offline");
        return j.reply || "";
      } catch (e) {
        console.error(e);
        return "Brain offline.";
      }
    }

    async function sendMessage(){
      const input = (inputEl?.value || "").trim(); if (!input) return;
      addMessage("user", input); inputEl.value = ""; setStatus("Thinking‚Ä¶");
      let reply = await apiChat(input);
      setStatus("");
      addMessage("bot", reply); speakText(reply);
      (memory.history ||= []).push({ user: input, bot: reply });
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

    (async ()=>{
      addMessage("bot","What‚Äôs the crisis today, Fire?");
      try {
        const h=await fetch("/api/health"); const hj=await h.json();
        const miss=[]; if(!hj.has_OPENAI_API_KEY) miss.push("OPENAI_API_KEY");
        setStatus(miss.length?`Missing env(s): ${miss.join(", ")}`:"Ready");
      } catch { setStatus("Health check failed."); }
    })();
  </script>
</body>
</html>
