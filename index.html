<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unfavorable-Chatbox</title>
  <style>
    body {
      background-color: #111; color: #eee; font-family: Arial, sans-serif;
      margin: 0; padding: 0; display: flex; flex-direction: row; height: 100vh;
    }
    #sidebar {
      width: 50px; background-color: #1a1a1a; padding: 5px;
      display: flex; flex-direction: column; gap: 6px; overflow-y: auto; align-items: center; position: relative;
    }
    #main {
      flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px;
    }
    button.function-btn { width: 100%; padding: 6px; background-color: #333; color: #eee; border: none; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
    button.function-btn:hover { background-color: #555; }
    #functionPanel.hidden { display: none; }
    #functionPanel {
      position: absolute; top: 45px; left: 65px; background: #222; border: 1px solid #444; padding: 10px; border-radius: 4px;
      display: flex; flex-direction: column; gap: 6px; z-index: 10;
    }
    /* Chat box size: smaller per your request */
    #chatBox {
      width: 85%; max-width: 420px; height: 240px; overflow-y: auto;
      background: #222; border: 1px solid #444; padding: 6px; margin-top: 20px; font-size: 14px;
    }
    .user-message { text-align: right; margin: 5px; color: #99f; white-space: pre-wrap; }
    .bot-message  { text-align: left;  margin: 5px; color: #9f9; white-space: pre-wrap; }
    #controls { display: flex; gap: 10px; align-items: center; }
    #userInput { width: auto; flex: 1; padding: 8px; }
    button { padding: 8px 12px; cursor: pointer; }
    #avatarImage {
      margin-top: 20px; width: 600px; height: 600px; background-color: #333; border-radius: 50%;
      box-shadow: 0 0 15px #0ff; transition: box-shadow 0.2s ease, transform 0.2s ease; object-fit: cover; flex-shrink: 0;
    }
    @keyframes pulse { 0%{box-shadow:0 0 20px #0f0; transform:scale(1);} 50%{box-shadow:0 0 40px #0ff; transform:scale(1.05);} 100%{box-shadow:0 0 20px #0f0; transform:scale(1);} }
    .hidden { display: none; }
    .status { font-size: 12px; opacity: .8; margin-top: 8px; min-height: 1em; }
  </style>
</head>
<body>
  <div id="sidebar">
    <button class="function-btn" onclick="togglePanel()">⚙️</button>
    <div id="functionPanel" class="hidden">
      <button class="function-btn" onclick="showSubpanel('chat')">💬</button>
      <button class="function-btn" onclick="showSubpanel('memory')">🧠</button>
      <button class="function-btn" onclick="showSubpanel('history')">📜</button>
      <button class="function-btn" onclick="showSubpanel('personality')">🎭</button>
      <button class="function-btn" onclick="showSubpanel('dimensions')">🌌</button>
      <button class="function-btn" onclick="showSubpanel('cleanse')">🧹</button>
      <button class="function-btn" onclick="showSubpanel('calendar')">📆</button>
      <button class="function-btn" onclick="showSubpanel('files')">📁</button>
      <button class="function-btn" onclick="showSubpanel('search')">🔍</button>
    </div>
  </div>

  <div id="main">
    <!-- Avatar stays in your images/ folder -->
    <img id="avatarImage" src="images/cartoonpersona.png" alt="Avatar">
    <div style="display:flex; flex-direction:column; flex-grow:1; justify-content:space-between; height:100%;">
      <div id="chatBox"></div>
      <div id="controls" style="margin-top:auto; display:flex; justify-content:space-between; padding:10px 0;">
        <input type="text" id="userInput" placeholder="Say something…">
        <button id="micBtn" title="Tap to talk">🎙️</button>
        <button id="sendBtn">Send</button>
      </div>
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    /* ===== Panels (kept minimal) ===== */
    function togglePanel(){ const p=document.getElementById('functionPanel'); if(p) p.classList.toggle('hidden'); }
    function showSubpanel(_id){}

    /* ===== State ===== */
    const memory = { mood:"neutral", fragments:[], history:[], identity:"Spark", dimension:"base", voiceMode:true, casualTone:true };
    let remoteMemory = {};

    /* ===== DOM ===== */
    const sendBtn   = document.getElementById("sendBtn");
    const micBtn    = document.getElementById("micBtn");
    const inputEl   = document.getElementById("userInput");
    const chatBox   = document.getElementById("chatBox");
    const statusEl  = document.getElementById("status");
    const avatarImg = document.getElementById("avatarImage");

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function addMessage(sender, message) {
      const msgDiv = document.createElement("div");
      msgDiv.className = sender === "user" ? "user-message" : "bot-message";
      msgDiv.textContent = message;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    /* ===== Voice (OUT) ===== */
    function speakText(text){
      try {
        if (!window.speechSynthesis) return;
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1; u.pitch = 1; u.volume = 1;
        u.onstart = ()=> { if (avatarImg) avatarImg.style.animation = "pulse 1s ease-in-out infinite"; };
        u.onend   = ()=> { if (avatarImg) avatarImg.style.animation = ""; };
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch {}
    }

    /* ===== Voice (IN) — tap to start/stop ===== */
    (() => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!micBtn) return;

      if (!SR) {
        micBtn.title = "Voice not supported on this browser";
        return;
      }

      const rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      let listening = false;

      function startRec() {
        try {
          rec.start();
          listening = true;
          micBtn.textContent = "🛑";
          micBtn.title = "Tap to stop";
          setStatus("Listening…");
        } catch {}
      }
      function stopRec() {
        try { rec.stop(); } catch {}
        listening = false;
        micBtn.textContent = "🎙️";
        micBtn.title = "Tap to talk";
        setStatus("");
      }

      micBtn.addEventListener("click", () => { listening ? stopRec() : startRec(); });

      rec.onresult = (ev) => {
        const transcript = ev.results[0][0].transcript;
        inputEl.value = transcript;
        sendMessage();
      };
      rec.onerror = (ev) => {
        stopRec();
        setStatus(ev.error === "not-allowed" ? "Mic blocked — allow microphone access in Site settings." : "Mic error: " + ev.error);
      };
      rec.onend = () => { if (listening) stopRec(); };
    })();

    /* ===== Remote Memory ===== */
    async function loadRemoteMemory(){
      try {
        const r = await fetch("/api/memory");
        if (r.ok) remoteMemory = await r.json(); else remoteMemory = {};
      } catch { remoteMemory = {}; }
    }
    async function saveRemoteFacts(obj){
      try { await fetch("/api/memory", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(obj||{}) }); } catch {}
    }

    /* ===== Chat Bridge ===== */
    function buildMessages() {
      const msgs = [];
      (memory.history || []).forEach(pair=>{
        if (pair.user) msgs.push({ role:"user", content: pair.user });
        if (pair.bot)  msgs.push({ role:"assistant", content: pair.bot });
      });
      return msgs;
    }

    async function apiChat(userText){
      const base = buildMessages();
      base.push({ role:"user", content: userText });

      const personaNote = `Slightly sarcastic, loyal to Josh. CasualTone=${!!memory.casualTone}`;
      const payload = { messages: base, memory: { personaNote, facts: remoteMemory?.facts || {} } };

      const r = await fetch("/api/chat", {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j?.error || "brain_offline");
      return j.reply || "";
    }

    function extractFact(text){
      const m = text.match(/I'll remember:? (.+?)=(.+?)(?:\.|$)/i);
      if (!m) return null;
      return { [m[1].trim()]: m[2].trim() };
    }

    /* ===== Send flow ===== */
    async function sendMessage(){
      const input = (inputEl?.value || "").trim();
      if (!input) return;
      addMessage("user", input);
      inputEl.value = "";
      setStatus("Thinking…");

      let reply = "";
      try {
        await loadRemoteMemory();
        reply = await apiChat(input);
        setStatus("");
      } catch (e) {
        setStatus("Brain offline — check /api/health (ENVs).");
        reply = "My brain isn't responding. Peek /api/health to see what's missing.";
      }

      addMessage("bot", reply);
      speakText(reply);

      memory.history = memory.history || [];
      memory.history.push({ user: input, bot: reply });

      const fact = extractFact(reply);
      if (fact) await saveRemoteFacts({ facts: fact });
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e)=>{ if (e.key === "Enter") sendMessage(); });

    /* ===== Boot ===== */
    (async () => {
      await loadRemoteMemory();
      addMessage("bot", "What’s the crisis today, Josh?");
      // Quick ping to show if backend is reachable (small + silent)
      try {
        const r = await fetch("/api/chat");
        if (r.ok) setStatus("Chat endpoint: OK"); else setStatus("Chat endpoint error — check /api/health");
      } catch { setStatus("Chat endpoint error — check /api/health"); }
    })();
  </script>
</body>
</html>
